<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>図形検出サイト (GitHub Pages / OpenCV.js)</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif; margin: 24px; }
    h1 { font-size: 1.8rem; margin: 0 0 .25rem; }
    .card { max-width: 980px; border: 1px solid #d0d0d0; border-radius: 16px; padding: 16px; box-shadow: 0 4px 20px rgba(0,0,0,.06); }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    label.button { display:inline-flex; align-items:center; gap:.5rem; background:#222; color:#fff; padding:.6rem 1rem; border-radius:999px; cursor:pointer; }
    input[type=file]{ display:none; }
    canvas { max-width: 100%; height: auto; border-radius: 10px; }
    .counts { font-weight: 600; margin-top: 8px; }
    .muted { opacity: .75; font-size: .9rem; }
    #cv-status { font-weight: 700; margin: .25rem 0 .75rem; }
  </style>
</head>
<body>
  <div class="card">
    <h1>🔵 図形検出サイト（OpenCV.js 版）</h1>
    <p class="muted">画像をアップロードすると、<b>丸・三角・四角</b> をブラウザ内だけで検出します（正方形/長方形の区別なし）。データはサーバーに送信されません。</p>

    <!-- ✅ OpenCV.js の読み込み状態を表示 -->
    <p id="cv-status" style="color:gray;">⏳ OpenCV.js の読み込みを待機中...</p>

    <div class="row" style="margin:.5rem 0 1rem;">
      <label class="button">📤 画像を選ぶ <input id="file" type="file" accept="image/*" disabled /></label>
      <span class="muted">※ 読み込み完了後にボタンが有効になります</span>
    </div>

    <canvas id="canvas"></canvas>
    <div id="counts" class="counts">未処理</div>
  </div>

  <!-- ===== OpenCV.js ローダ（複数CDNを順番にトライ） ===== -->
  <script>
    // 読み込み候補（上から順に試行）
    const OPENCV_URLS = [
      "https://docs.opencv.org/4.9.0/opencv.js",
      "https://unpkg.com/@techstark/opencv-js@4.9.0-1/dist/opencv.js",
      "https://cdn.jsdelivr.net/gh/opencv/opencv@4.x/dist/opencv.js"
    ];

    const statusEl = document.getElementById('cv-status');
    const fileInput = document.getElementById('file');

    let cvReady = false;

    function onCvReady() {
      // スクリプトが取れてもWASMの初期化待ちが必要なことがある
      if (window.cv) {
        if (cv.getBuildInformation) {
          cvReady = true;
          statusEl.textContent = "✅ OpenCV.js 読み込み完了（即時）";
          statusEl.style.color = "green";
          fileInput.disabled = false;
        } else {
          cv['onRuntimeInitialized'] = () => {
            cvReady = true;
            statusEl.textContent = "✅ OpenCV.js 初期化完了";
            statusEl.style.color = "green";
            fileInput.disabled = false;
          };
        }
      } else {
        statusEl.textContent = "❌ OpenCV.js が見つかりません";
        statusEl.style.color = "red";
      }
    }

    function loadOpenCvSequential(urls) {
      if (!urls.length) {
        statusEl.textContent = "❌ OpenCV.js の読み込みに失敗しました（全CDN NG）";
        statusEl.style.color = "red";
        return;
      }
      const url = urls[0];
      statusEl.textContent = `⏳ OpenCV.js を読み込み中… ${url}`;
      statusEl.style.color = "gray";

      const s = document.createElement("script");
      s.async = true;
      s.src = url;
      s.onload = onCvReady;
      s.onerror = () => {
        // 次の候補へ
        loadOpenCvSequential(urls.slice(1));
      };
      document.body.appendChild(s);
    }

    // 起動時に読み込み開始
    loadOpenCvSequential(OPENCV_URLS);
  </script>

  <!-- ===== 図形検出の本体 ===== -->
  <script>
    // 調整用パラメータ
    const MIN_AREA = 500;       // 小さいゴミを除去（px^2）
    const APPROX_COEF = 0.02;   // 多角形近似係数（小さいほど頂点が増えやすい）
    const CIRCLE_THRESH = 0.80; // 円度しきい値（高いほど真円のみを丸扱い）

    const canvas = document.getElementById('canvas');
    const countsEl = document.getElementById('counts');

    // 画像を読み込んで HTMLImageElement を返す
    function loadImage(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
    }

    function classifyShape(cnt) {
      const area = cv.contourArea(cnt);
      if (area < MIN_AREA) return null;
      const peri = cv.arcLength(cnt, true);
      const approx = new cv.Mat();
      cv.approxPolyDP(cnt, approx, APPROX_COEF * peri, true);
      const v = approx.rows;
      approx.delete();
      if (v === 3) return "triangle";
      if (v === 4) return "square"; // 正方形/長方形の区別なし
      const circularity = 4 * Math.PI * area / (peri * peri + 1e-6);
      if (circularity >= CIRCLE_THRESH) return "circle";
      return null;
    }

    async function handleFile(e) {
      const file = e.target.files?.[0];
      if (!file) return;
      if (!cvReady) {
        alert("OpenCV.js の準備中です。数秒待ってから再試行してください。");
        return;
      }

      // 画像をCanvasへ描画
      const imgEl = await loadImage(file);
      const w = imgEl.naturalWidth, h = imgEl.naturalHeight;
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(imgEl, 0, 0, w, h);

      // Canvas → Mat
      let src = cv.imread(canvas);
      let gray = new cv.Mat(), blur = new cv.Mat(), bw = new cv.Mat();
      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
      cv.GaussianBlur(gray, blur, new cv.Size(5,5), 0, 0, cv.BORDER_DEFAULT);
      cv.threshold(blur, bw, 0, 255, cv.THRESH_BINARY_INV + cv.THRESH_OTSU);

      // 輪郭抽出
      let contours = new cv.MatVector(), hierarchy = new cv.Mat();
      cv.findContours(bw, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

      // 可視化
      let vis = src.clone();
      const green = new cv.Scalar(0,200,0,255);
      const count = { circle:0, triangle:0, square:0 };

      for (let i = 0; i < contours.size(); i++) {
        const cnt = contours.get(i);
        const label = classifyShape(cnt);
        if (!label) { cnt.delete(); continue; }
        count[label]++;

        const rect = cv.boundingRect(cnt);
        cv.rectangle(
          vis,
          new cv.Point(rect.x, rect.y),
          new cv.Point(rect.x + rect.width, rect.y + rect.height),
          green, 2
        );
        cv.putText(
          vis, label,
          new cv.Point(rect.x, Math.max(0, rect.y - 6)),
          cv.FONT_HERSHEY_SIMPLEX, 0.7, green, 2
        );
        cnt.delete();
      }

      // 描画とカウント表示
      cv.imshow(canvas, vis);
      countsEl.textContent = `🔵 丸: ${count.circle}　🟩 四角: ${count.square}　🔺 三角: ${count.triangle}`;

      // 後片付け（メモリ解放）
      src.delete(); gray.delete(); blur.delete(); bw.delete();
      contours.delete(); hierarchy.delete(); vis.delete();
    }

    fileInput.addEventListener('change', handleFile);
  </script>
</body>
</html>
